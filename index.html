<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Wordle Duell</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:#080808;color:#ccc;font-family:'Courier New',monospace;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px 10px 60px}
.vs-title{font-size:26px;letter-spacing:10px;font-weight:700;background:linear-gradient(90deg,#4a9eff,#ff6b8a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.subtitle{color:#555;font-size:11px;letter-spacing:4px;margin-top:4px;text-align:center}
.panel{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:8px;padding:24px}
button{font-family:'Courier New',monospace;cursor:pointer;letter-spacing:2px;transition:all 0.2s;border-radius:4px;border:none}
.btn{background:transparent;border:1px solid #333;color:#888;font-size:11px;padding:9px 20px}
.btn:hover{border-color:#555;color:#ccc}
.btn-go{background:linear-gradient(90deg,#1a3a6a,#6a1a2a);border:1px solid #555;color:#fff;padding:11px 36px;font-size:12px}
.btn-go:disabled{opacity:0.3;cursor:not-allowed}
.btn-danger{border:1px solid #6a1a1a;color:#ff4444;background:#1a0808;font-size:10px;padding:7px 16px;letter-spacing:1px}
label{color:#555;font-size:10px;letter-spacing:2px;display:block;margin-bottom:5px;margin-top:12px}
input[type=text],input[type=password],input[type=number]{background:#0a0a0a;border:1px solid #333;color:#fff;border-radius:4px;padding:10px 12px;font-family:'Courier New',monospace;font-size:15px;width:100%;outline:none;transition:border-color 0.2s}
input:focus{border-color:#555}
input[type=number]{-moz-appearance:textfield}
input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
.tile{width:52px;height:52px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;border-radius:4px;border:2px solid #1a1a1a;background:#0d0d0d;color:transparent;transition:background 0.3s,border-color 0.3s,color 0.15s,transform 0.1s;flex-shrink:0;user-select:none}
.tile.filled-a{border-color:#4a9eff;background:#0d1f3a;color:#4a9eff}
.tile.filled-b{border-color:#ff6b8a;background:#3a0d1a;color:#ff6b8a}
.tile.correct{background:#2d7a3a;border-color:#4ab855;color:#fff}
.tile.present{background:#8a6010;border-color:#c89030;color:#fff}
.tile.absent{background:#1a1a1a;border-color:#1a1a1a;color:#444}
.tile.cursor-a{box-shadow:0 0 0 3px #4a9eff,0 0 10px #4a9eff55}
.tile.cursor-b{box-shadow:0 0 0 3px #ff6b8a,0 0 10px #ff6b8a55}
.tile.editable:hover{transform:scale(1.1);cursor:pointer}
.grid{display:flex;flex-direction:column;gap:5px}
.grid-row{display:flex;gap:5px}
.keyboard{display:flex;flex-direction:column;gap:4px;margin-top:14px}
.kb-row{display:flex;gap:3px;justify-content:center}
.key{background:#1e1e2e;color:#888;border:1px solid #333;border-radius:4px;font-weight:700;width:30px;height:38px;font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-family:'Courier New',monospace;transition:background 0.15s,color 0.15s}
.key:active{transform:scale(0.93)}
.key.wide-enter{width:54px;font-size:8px;letter-spacing:0.5px}
.key.wide-del{width:40px}
.key.key-correct{background:#2d7a3a;color:#fff;border-color:#4ab855}
.key.key-present{background:#8a6010;color:#fff;border-color:#c89030}
.key.key-absent{background:#111;color:#333;border-color:#111}
#play-screen{display:flex;width:100%;max-width:960px;flex-direction:row}
@media(max-width:640px){
  #play-screen{flex-direction:column}
  .side-b{border-left:none!important;border-top:1px solid #111}
  .tile{width:46px;height:46px;font-size:19px}
  .key{width:27px;height:36px;font-size:12px}
  .key.wide-enter{width:48px}
  .key.wide-del{width:36px}
}
.side{flex:1;display:flex;flex-direction:column;align-items:center;padding:16px 10px;border-top:3px solid}
.side-a{background:#060d1a;border-color:#4a9eff}
.side-b{background:#1a060d;border-color:#ff6b8a;border-left:1px solid #111}
.timer-wrap{width:100%;margin-bottom:10px}
.timer-bar{height:5px;background:#1a1a1a;border-radius:3px;overflow:hidden}
.timer-fill{height:100%;border-radius:3px;transition:width 0.4s linear,background 0.4s}
.timer-label{font-size:11px;text-align:right;margin-top:3px;font-weight:700;min-height:16px;letter-spacing:1px}
.toast{background:#111;border:1px solid #333;border-radius:4px;padding:8px 20px;font-size:12px;letter-spacing:1px;color:#ccc;margin-bottom:10px;text-align:center;animation:fadeDown 0.2s;max-width:500px;width:100%}
@keyframes fadeDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-7px)}40%{transform:translateX(7px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.invalid-shake{animation:shake 0.4s}
.waiting-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin:0 2px;animation:pulse 1.2s infinite}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #151515;font-size:12px}
#admin-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;align-items:center;justify-content:center}
</style>
</head>
<body>

<div style="text-align:center;margin-bottom:18px;width:100%">
  <div class="vs-title">WORDLE DUELL</div>
  <div id="phase-label" class="subtitle"></div>
</div>
<div id="toast" class="toast" style="display:none"></div>

<!-- QR always visible at top -->
<div style="text-align:center;margin-bottom:20px;opacity:0.7">
  <div style="font-size:9px;letter-spacing:3px;color:#444;margin-bottom:8px">MITSPIELEN — QR-CODE SCANNEN</div>
  <div id="qrcode" style="display:inline-block;background:#fff;padding:8px;border-radius:6px"></div>
  <div style="font-size:9px;color:#333;margin-top:6px;letter-spacing:1px">disswurdjetztaberauchzeit.github.io/wordle-duell</div>
</div>

<!-- LOGIN -->
<div id="login-screen" style="display:none;width:100%;max-width:460px">
  <div class="panel" style="border-color:#222">
    <div style="color:#666;font-size:10px;letter-spacing:3px;margin-bottom:22px;text-align:center">ANMELDEN</div>
    <label>DEIN NAME</label>
    <input type="text" id="login-name" placeholder="Name eingeben..." maxlength="20" onkeydown="if(event.key==='Enter')doLogin()"/>
    <label>MAX. FEHLVERSUCHE <span style="color:#2a2a2a">(niedrigere Zahl beider Spieler gilt)</span></label>
    <input type="number" id="login-maxfail" value="6" min="1" max="20" style="margin-bottom:4px"/>
    <label>TIMER PRO ZEILE <span style="color:#2a2a2a">(Minuten, 0 = kein Timer)</span></label>
    <input type="number" id="login-timer" value="0" min="0" max="30" step="0.5" style="margin-bottom:18px"/>
    <button class="btn-go" style="width:100%" onclick="doLogin()">SPIELEN</button>
    <div id="login-waiting" style="display:none;color:#555;font-size:11px;letter-spacing:2px;text-align:center;margin-top:16px;padding:10px">
      <span class="waiting-dot" style="background:#4a9eff"></span>
      <span class="waiting-dot" style="background:#ff6b8a;animation-delay:0.4s"></span>
      <span class="waiting-dot" style="background:#4a9eff;animation-delay:0.8s"></span>
      <div style="margin-top:8px" id="login-wait-msg"></div>
    </div>
  </div>
  <div style="text-align:center;margin-top:14px;display:flex;gap:10px;justify-content:center">
    <button class="btn" onclick="showAdmin()">STATISTIK (ADMIN)</button>
    <button class="btn btn-danger" onclick="hardReset()">NEUSTART</button>
  </div>
</div>

<!-- PICK -->
<div id="pick-screen" style="display:none;width:100%;max-width:720px">
  <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center">
    <div class="panel" style="border-color:#1a3a6a;min-width:270px;flex:1">
      <div id="pick-title-a" style="color:#4a9eff;font-size:11px;letter-spacing:3px;margin-bottom:14px;font-weight:700"></div>
      <div style="color:#444;font-size:10px;margin-bottom:6px">Woerter komma-getrennt (je 5 Buchstaben):</div>
      <input type="text" id="pick-input-a" placeholder="HUNDE, KATZE, VOGEL..." oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')submitPick('A')"/>
      <div id="pick-msg-a" style="color:#e05030;font-size:10px;min-height:14px;margin-bottom:8px"></div>
      <div id="pick-done-a" style="display:none;color:#4ab855;font-size:11px;letter-spacing:2px;text-align:center;padding:10px">WOERTER GESETZT</div>
      <button class="btn" id="pick-btn-a" style="border-color:#1a3a6a;color:#4a9eff;background:#060d1a;width:100%" onclick="submitPick('A')">FESTLEGEN</button>
    </div>
    <div class="panel" style="border-color:#6a1a2a;min-width:270px;flex:1">
      <div id="pick-title-b" style="color:#ff6b8a;font-size:11px;letter-spacing:3px;margin-bottom:14px;font-weight:700"></div>
      <div style="color:#444;font-size:10px;margin-bottom:6px">Woerter komma-getrennt (je 5 Buchstaben):</div>
      <input type="text" id="pick-input-b" placeholder="HUNDE, KATZE, VOGEL..." oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')submitPick('B')"/>
      <div id="pick-msg-b" style="color:#e05030;font-size:10px;min-height:14px;margin-bottom:8px"></div>
      <div id="pick-done-b" style="display:none;color:#ff6b8a;font-size:11px;letter-spacing:2px;text-align:center;padding:10px">WOERTER GESETZT</div>
      <button class="btn" id="pick-btn-b" style="border-color:#6a1a2a;color:#ff6b8a;background:#1a060d;width:100%" onclick="submitPick('B')">FESTLEGEN</button>
    </div>
  </div>
  <div style="text-align:center;margin-top:18px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="btn btn-danger" onclick="forfeit()">AUFGEBEN</button>
    <button class="btn" onclick="hardReset()">NEUSTART (neue Spieler)</button>
  </div>
</div>

<!-- PLAY -->
<div id="play-screen" style="display:none">
  <div class="side side-a" id="side-a" onclick="setActive('A')">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span id="name-display-a" style="color:#4a9eff;font-size:13px;font-weight:700;letter-spacing:3px"></span>
      <span id="attempts-a" style="color:#333;font-size:11px"></span>
    </div>
    <div class="timer-wrap" id="timer-wrap-a" style="display:none">
      <div class="timer-bar"><div class="timer-fill" id="tfill-a" style="width:100%;background:#4a9eff"></div></div>
      <div class="timer-label" id="tlabel-a" style="color:#4a9eff"></div>
    </div>
    <div id="done-banner-a" style="display:none;border-radius:6px;padding:9px 14px;margin-bottom:10px;text-align:center;font-size:11px;letter-spacing:2px"></div>
    <div id="main-grid-a" class="grid"></div>
    <div id="keyboard-a" class="keyboard"></div>
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <button class="btn btn-danger" onclick="forfeit()">AUFGEBEN</button>
      <button class="btn" onclick="hardReset()">NEUSTART</button>
    </div>
  </div>
  <div class="side side-b" id="side-b" onclick="setActive('B')">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span id="name-display-b" style="color:#ff6b8a;font-size:13px;font-weight:700;letter-spacing:3px"></span>
      <span id="attempts-b" style="color:#333;font-size:11px"></span>
    </div>
    <div class="timer-wrap" id="timer-wrap-b" style="display:none">
      <div class="timer-bar"><div class="timer-fill" id="tfill-b" style="width:100%;background:#ff6b8a"></div></div>
      <div class="timer-label" id="tlabel-b" style="color:#ff6b8a"></div>
    </div>
    <div id="done-banner-b" style="display:none;border-radius:6px;padding:9px 14px;margin-bottom:10px;text-align:center;font-size:11px;letter-spacing:2px"></div>
    <div id="main-grid-b" class="grid"></div>
    <div id="keyboard-b" class="keyboard"></div>
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <button class="btn btn-danger" onclick="forfeit()">AUFGEBEN</button>
      <button class="btn" onclick="hardReset()">NEUSTART</button>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="result-screen" style="display:none;flex-direction:column;align-items:center">
  <div id="winner-text" style="font-size:18px;letter-spacing:6px;font-weight:700;margin-bottom:20px;text-align:center"></div>
  <div id="result-cards" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-bottom:24px"></div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
    <button class="btn-go" onclick="newGame()">NAECHSTE RUNDE</button>
    <button class="btn" onclick="hardReset()">NEUSTART (neue Spieler)</button>
  </div>
</div>

<!-- ADMIN -->
<div id="admin-panel">
  <div class="panel" style="border-color:#333;min-width:320px;max-width:540px;width:92%;max-height:88vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="color:#888;font-size:12px;letter-spacing:4px">STATISTIK</div>
      <button class="btn" onclick="closeAdmin()">X</button>
    </div>
    <div id="admin-login">
      <div style="color:#444;font-size:10px;line-height:1.7;margin-bottom:10px">Merksatz: "Ich mag Worte, die man nicht aussprechen kann." - Karl Valentin</div>
      <input type="password" id="admin-pw-input" placeholder="Passwort..." onkeydown="if(event.key==='Enter')checkAdminPw()"/>
      <button class="btn" style="width:100%;margin-top:4px" onclick="checkAdminPw()">ENTSPERREN</button>
      <div id="admin-pw-msg" style="color:#e05030;font-size:10px;margin-top:8px;min-height:14px"></div>
    </div>
    <div id="admin-content" style="display:none">
      <div id="stats-list"></div>
      <div style="margin-top:18px;padding-top:14px;border-top:1px solid #1a1a1a;display:flex;gap:10px">
        <button class="btn btn-danger" style="flex:1" onclick="clearStats()">LOESCHEN</button>
        <button class="btn" style="flex:1" onclick="closeAdmin()">SCHLIESSEN</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCCMItvN8RNbnWi_V6KdBmhYwFxl53R9R0",
  authDomain:"wordle-duell.firebaseapp.com",
  projectId:"wordle-duell",
  storageBucket:"wordle-duell.firebasestorage.app",
  messagingSenderId:"10346209099",
  appId:"1:10346209099:web:409827941bd01a5b6c12ce"
});
const db = getFirestore(app);

// "Ich mag Worte, die man nicht aussprechen kann." - Karl Valentin
const ADMIN_PW = "Wrglpfrmpft";
const KB_ROWS = [
  ["Q","W","E","R","T","Z","U","I","O","P","UE"],
  ["A","S","D","F","G","H","J","K","L","OE","AE"],
  ["ENTER","Y","X","C","V","B","N","M","DEL"]
];
const KB_DISPLAY = {
  "UE":"Ü","OE":"Ö","AE":"Ä","ENTER":"ENTER","DEL":"⌫"
};
const KB_VALUES = {
  "UE":"Ü","OE":"Ö","AE":"Ä","ENTER":"ENTER","DEL":"⌫"
};

let state=null, myRole=null, adminOpen=false, unsub=null, timerIv=null;
let inputA="", inputB="", cursorA=0, cursorB=0, activeKB="A";

function fresh(){return{phase:"login",nameA:"",nameB:"",maxFail:6,timerMin:0,wordListA:[],wordListB:[],wordIdxA:0,wordIdxB:0,pickedA:false,pickedB:false,histA:[],histB:[],doneA:false,wonA:false,doneB:false,wonB:false,forfeitBy:"",rowStartA:null,rowStartB:null};}

async function fsRead(p){const[c,i]=p.split("/");const s=await getDoc(doc(db,c,i));return s.exists()?s.data():null;}
async function fsWrite(p,d){const[c,i]=p.split("/");await setDoc(doc(db,c,i),d);}

function subscribe(){
  if(unsub)unsub();
  unsub=onSnapshot(doc(db,"duel","state"),snap=>{
    state=snap.exists()?snap.data():fresh();
    if(!snap.exists())fsWrite("duel/state",state);
    renderAll();
  });
}

window.doLogin=async function(){
  const name=document.getElementById("login-name").value.trim();
  const mf=parseInt(document.getElementById("login-maxfail").value)||6;
  const tm=parseFloat(document.getElementById("login-timer").value)||0;
  if(!name){showToast("Bitte Namen eingeben");return;}
  const cur=state||fresh();
  if(!cur.nameA){
    myRole="A";
    await fsWrite("duel/state",{...cur,nameA:name,maxFail:mf,timerMin:tm});
    document.getElementById("login-waiting").style.display="block";
    document.getElementById("login-wait-msg").textContent=name+" wartet auf Mitspieler...";
  }else if(!cur.nameB){
    myRole="B";
    const maxFail=Math.min(cur.maxFail||6,mf);
    const timerMin=(cur.timerMin>0||tm>0)?(cur.timerMin>0&&tm>0?Math.min(cur.timerMin,tm):Math.max(cur.timerMin,tm)):0;
    await fsWrite("duel/state",{...cur,nameB:name,maxFail,timerMin,phase:"pick"});
  }else{
    if(cur.nameA===name)myRole="A";
    else if(cur.nameB===name)myRole="B";
    else{showToast("Spiel laeuft bereits - Neustart noetig");return;}
  }
};

window.hardReset=async function(){
  if(!confirm("Neustart? Beide Spieler muessen sich neu anmelden."))return;
  myRole=null;inputA="";inputB="";cursorA=0;cursorB=0;
  stopTimer();
  await fsWrite("duel/state",fresh());
};

window.submitPick=async function(player){
  const raw=document.getElementById("pick-input-"+player.toLowerCase()).value;
  const words=raw.split(",").map(w=>w.trim().toUpperCase().replace(/[^A-ZAEOEUE]/g,"")).filter(w=>w.length===5);
  const msg=document.getElementById("pick-msg-"+player.toLowerCase());
  if(!words.length){msg.textContent="Mindestens ein 5-Buchstaben-Wort eingeben";return;}
  msg.textContent="";
  const now=Date.now();
  const upd={...state};
  if(player==="A"){upd.wordListA=words;upd.pickedA=true;}
  else{upd.wordListB=words;upd.pickedB=true;}
  if(upd.pickedA&&upd.pickedB){Object.assign(upd,{phase:"play",histA:[],histB:[],doneA:false,wonA:false,doneB:false,wonB:false,wordIdxA:0,wordIdxB:0,forfeitBy:"",rowStartA:now,rowStartB:now});}
  await fsWrite("duel/state",upd);
};

window.forfeit=async function(){
  if(!confirm("Wirklich aufgeben?"))return;
  const upd={...state,forfeitBy:myRole||"?",phase:"result",doneA:true,doneB:true};
  if(myRole==="A"){upd.wonA=false;upd.wonB=true;}else{upd.wonB=false;upd.wonA=true;}
  await fsWrite("duel/state",upd);
  await saveResult(upd);
};

function evaluate(guess,target){
  const res=Array(5).fill("absent"),t=[...target],g=[...guess];
  g.forEach((c,i)=>{if(c===t[i]){res[i]="correct";t[i]=null;g[i]=null;}});
  g.forEach((c,i)=>{if(!c)return;const ti=t.indexOf(c);if(ti!==-1){res[i]="present";t[ti]=null;}});
  return res;
}
function keyState(letter,hist){
  let best="unused";
  for(const row of hist){row.word.split("").forEach((c,i)=>{if(c!==letter)return;const s=row.states[i];if(s==="correct")best="correct";else if(s==="present"&&best!=="correct")best="present";else if(s==="absent"&&best==="unused")best="absent";});}
  return best;
}

function insertAt(str,pos,char){
  const arr=(str+"     ").slice(0,5).split("");
  arr[pos]=char;
  return arr.join("").replace(/ +$/,"");
}

window.handleTileClick=function(player,pos){
  if(player==="A")cursorA=pos; else cursorB=pos;
  setActive(player);
  renderPlay();
};

async function submitGuess(player){
  if(!state||state.phase!=="play")return;
  const done=player==="A"?state.doneA:state.doneB;
  if(done)return;
  const inp=player==="A"?inputA:inputB;
  const wlist=player==="A"?state.wordListB:state.wordListA;
  const widx=player==="A"?state.wordIdxA:state.wordIdxB;
  const target=wlist[widx%wlist.length];
  const maxF=state.maxFail||6;
  if(inp.length!==5){shakeCurrent(player);showToast("5 Buchstaben noetig");return;}
  const states=evaluate(inp,target);
  const won=inp===target;
  const now=Date.now();
  const upd={...state,histA:[...state.histA],histB:[...state.histB]};
  if(player==="A"){
    upd.histA.push({word:inp,states});upd.rowStartA=now;
    if(won&&upd.wordIdxA+1<wlist.length){upd.wordIdxA++;upd.histA=[];}
    else if(won||upd.histA.length>=maxF){upd.doneA=true;upd.wonA=won;}
    inputA="";cursorA=0;
  }else{
    upd.histB.push({word:inp,states});upd.rowStartB=now;
    if(won&&upd.wordIdxB+1<wlist.length){upd.wordIdxB++;upd.histB=[];}
    else if(won||upd.histB.length>=maxF){upd.doneB=true;upd.wonB=won;}
    inputB="";cursorB=0;
  }
  if(upd.doneA&&upd.doneB){upd.phase="result";await fsWrite("duel/state",upd);await saveResult(upd);}
  else await fsWrite("duel/state",upd);
}

function shakeCurrent(player){
  const el=document.getElementById("main-grid-"+player.toLowerCase());
  const len=player==="A"?state.histA.length:state.histB.length;
  const row=el&&el.querySelectorAll(".grid-row")[len];
  if(row){row.classList.add("invalid-shake");setTimeout(()=>row.classList.remove("invalid-shake"),400);}
}

function stopTimer(){if(timerIv){clearInterval(timerIv);timerIv=null;}}
function startTimer(){
  stopTimer();
  timerIv=setInterval(()=>{
    if(!state||state.phase!=="play")return;
    const tm=state.timerMin||0;
    ["A","B"].forEach(p=>{
      const wrap=document.getElementById("timer-wrap-"+p.toLowerCase());
      const fill=document.getElementById("tfill-"+p.toLowerCase());
      const lbl=document.getElementById("tlabel-"+p.toLowerCase());
      if(!wrap||!fill||!lbl)return;
      if(!tm||tm<=0){wrap.style.display="none";return;}
      wrap.style.display="block";
      const done=p==="A"?state.doneA:state.doneB;
      if(done){fill.style.width="0%";lbl.textContent="";return;}
      const startTs=p==="A"?state.rowStartA:state.rowStartB;
      if(!startTs)return;
      const totalMs=tm*60000;
      const elapsed=Date.now()-startTs;
      const remaining=Math.max(0,totalMs-elapsed);
      const pct=Math.max(0,(remaining/totalMs)*100);
      const secs=Math.ceil(remaining/1000);
      const m=Math.floor(secs/60),s=secs%60;
      fill.style.width=pct+"%";
      const col=pct>60?"#4ab855":pct>25?"#c89030":"#e05030";
      fill.style.background=col;
      lbl.style.color=col;
      lbl.textContent=(m>0?m+"m ":"")+s+"s";
      if(elapsed>=totalMs&&myRole===p){
        const inp=p==="A"?inputA:inputB;
        const padded=(inp+"XXXXX").slice(0,5);
        if(p==="A")inputA=padded;else inputB=padded;
        submitGuess(p);
      }
    });
  },400);
}

document.addEventListener("keydown",e=>{
  if(adminOpen||!state||state.phase!=="play")return;
  const p=activeKB;
  if(p==="A"?state.doneA:state.doneB)return;
  if(e.key==="Enter"){submitGuess(p);return;}
  const pos=p==="A"?cursorA:cursorB;
  const cur=p==="A"?inputA:inputB;
  if(e.key==="Backspace"){
    const arr=(cur+"     ").slice(0,5).split("");
    arr.splice(pos,1);arr.push(" ");
    const ns=arr.join("").replace(/ +$/,"");
    const np=Math.max(0,pos>0?pos-1:0);
    if(p==="A"){inputA=ns;cursorA=np;}else{inputB=ns;cursorB=np;}
    renderPlay();return;
  }
  let k=e.key.length===1?e.key.toUpperCase():null;
  if(k&&/^[A-ZAEOEUE]$/i.test(k)){
    if(k==="AE")k="Ä";else if(k==="OE")k="Ö";else if(k==="UE")k="Ü";
    const ns=insertAt(cur,pos,k);
    const np=Math.min(4,pos+1);
    if(p==="A"){inputA=ns;cursorA=np;}else{inputB=ns;cursorB=np;}
    renderPlay();
  }
});

window.setActive=function(p){activeKB=p;highlightActive();};
function highlightActive(){
  document.getElementById("side-a").style.outline=activeKB==="A"?"2px solid #4a9eff33":"none";
  document.getElementById("side-b").style.outline=activeKB==="B"?"2px solid #ff6b8a33":"none";
}

window.newGame=async function(){
  inputA="";inputB="";cursorA=0;cursorB=0;
  const s=fresh();
  s.nameA=state.nameA||"";s.nameB=state.nameB||"";
  s.maxFail=state.maxFail||6;s.timerMin=state.timerMin||0;
  s.phase=(s.nameA&&s.nameB)?"pick":"login";
  await fsWrite("duel/state",s);
};

async function saveResult(s){
  const attA=s.histA&&s.histA.length||0,attB=s.histB&&s.histB.length||0;
  let winner="";
  if(s.forfeitBy)winner=s.forfeitBy==="A"?s.nameB:s.nameA;
  else if(s.wonA&&!s.wonB)winner=s.nameA;
  else if(s.wonB&&!s.wonA)winner=s.nameB;
  else if(s.wonA&&s.wonB)winner=attA<=attB?s.nameA:s.nameB;
  const entry={date:new Date().toLocaleDateString("de-DE"),time:new Date().toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),playerA:s.nameA||"A",playerB:s.nameB||"B",attemptsA:attA,attemptsB:attB,wonA:!!s.wonA,wonB:!!s.wonB,forfeit:s.forfeitBy||"",winner};
  const cur=await fsRead("duel/stats")||{games:[]};
  cur.games=[...(cur.games||[]),entry];
  await fsWrite("duel/stats",cur);
}

function S(id,v){const el=document.getElementById(id);if(el)el.style.display=v;}
function showToast(m,d){const el=document.getElementById("toast");el.textContent=m;el.style.display="block";clearTimeout(el._t);el._t=setTimeout(()=>el.style.display="none",d||2500);}

function renderAll(){
  if(!state)return;
  const labels={login:"ANMELDEN",pick:"WOERTER WAEHLEN",play:"DUELL",result:"ERGEBNIS"};
  document.getElementById("phase-label").textContent=labels[state.phase]||"";
  S("login-screen",state.phase==="login"?"block":"none");
  S("pick-screen",state.phase==="pick"?"block":"none");
  S("play-screen",state.phase==="play"?"flex":"none");
  S("result-screen",state.phase==="result"?"flex":"none");
  if(state.phase==="login")renderLogin();
  if(state.phase==="pick")renderPick();
  if(state.phase==="play"){renderPlay();startTimer();}
  if(state.phase==="result"){renderResult();stopTimer();}
}

function renderLogin(){
  if(state.nameA&&!state.nameB){
    document.getElementById("login-waiting").style.display="block";
    document.getElementById("login-wait-msg").textContent=state.nameA+" wartet...";
  }
}

function renderPick(){
  const nA=state.nameA||"Spieler A",nB=state.nameB||"Spieler B";
  document.getElementById("pick-title-a").textContent=nA.toUpperCase()+" WAEHLT FUER "+nB.toUpperCase();
  document.getElementById("pick-title-b").textContent=nB.toUpperCase()+" WAEHLT FUER "+nA.toUpperCase();
  if(state.pickedA){S("pick-done-a","block");S("pick-btn-a","none");}
  if(state.pickedB){S("pick-done-b","block");S("pick-btn-b","none");}
}

function renderPlay(){
  if(!state||state.phase!=="play")return;
  const nA=state.nameA||"A",nB=state.nameB||"B";
  document.getElementById("name-display-a").textContent=nA.toUpperCase();
  document.getElementById("name-display-b").textContent=nB.toUpperCase();
  const maxF=state.maxFail||6;
  const wlA=state.wordListB||[],wlB=state.wordListA||[];
  const tA=wlA[(state.wordIdxA||0)%wlA.length]||"?????";
  const tB=wlB[(state.wordIdxB||0)%wlB.length]||"?????";
  let attA=state.histA.length+"/"+maxF,attB=state.histB.length+"/"+maxF;
  if(wlA.length>1)attA+=" Wort "+((state.wordIdxA||0)+1)+"/"+wlA.length;
  if(wlB.length>1)attB+=" Wort "+((state.wordIdxB||0)+1)+"/"+wlB.length;
  document.getElementById("attempts-a").textContent=attA;
  document.getElementById("attempts-b").textContent=attB;
  const showTimer=state.timerMin>0;
  document.getElementById("timer-wrap-a").style.display=showTimer?"block":"none";
  document.getElementById("timer-wrap-b").style.display=showTimer?"block":"none";
  renderMainGrid("main-grid-a",state.histA,inputA,cursorA,tA,"A",maxF);
  renderMainGrid("main-grid-b",state.histB,inputB,cursorB,tB,"B",maxF);
  renderDoneBanner("done-banner-a",state.doneA,state.wonA,tA,"A");
  renderDoneBanner("done-banner-b",state.doneB,state.wonB,tB,"B");
  renderKeyboard("keyboard-a",state.histA,"A");
  renderKeyboard("keyboard-b",state.histB,"B");
  highlightActive();
}

function renderMainGrid(id,hist,inp,cursor,target,player,maxF){
  const el=document.getElementById(id);el.innerHTML="";
  const done=player==="A"?state.doneA:state.doneB;
  const totalRows=Math.max(maxF,hist.length+(done?0:1));
  for(let r=0;r<totalRows;r++){
    const row=document.createElement("div");row.className="grid-row";
    const committed=r<hist.length,current=r===hist.length&&!done;
    const word=committed?hist[r].word:current?inp:"";
    const states=committed?hist[r].states:null;
    for(let c=0;c<5;c++){
      const t=document.createElement("div");t.className="tile";
      const l=word[c]||"";t.textContent=l;
      if(committed){t.classList.add(states[c]);}
      else if(current){
        if(l)t.classList.add("filled-"+player.toLowerCase());
        if(c===cursor&&!done)t.classList.add("cursor-"+player.toLowerCase());
        t.classList.add("editable");
        const cc=c;
        t.addEventListener("click",(e)=>{e.stopPropagation();window.handleTileClick(player,cc);});
      }
      row.appendChild(t);
    }
    el.appendChild(row);
  }
}

function renderDoneBanner(id,done,won,word,player){
  const el=document.getElementById(id);
  if(!done){el.style.display="none";return;}
  el.style.display="block";
  el.style.background=won?"#0d2a10":"#2a0d0a";
  el.style.border=won?"1px solid #4ab855":"1px solid #e05030";
  el.style.color=won?"#4ab855":"#e05030";
  el.innerHTML=won?"GELOEST!":"NICHT GELOEST - Wort: "+word;
}

function renderKeyboard(id,hist,player){
  const el=document.getElementById(id);el.innerHTML="";
  if(player==="A"?state.doneA:state.doneB)return;
  const rows=[["Q","W","E","R","T","Z","U","I","O","P","Ü"],["A","S","D","F","G","H","J","K","L","Ö","Ä"],["ENTER","Y","X","C","V","B","N","M","⌫"]];
  rows.forEach(row=>{
    const rowEl=document.createElement("div");rowEl.className="kb-row";
    row.forEach(k=>{
      const btn=document.createElement("button");btn.className="key";
      if(k==="ENTER")btn.classList.add("wide-enter");
      else if(k==="⌫")btn.classList.add("wide-del");
      btn.textContent=k;
      if(!["ENTER","⌫"].includes(k)){const ks=keyState(k,hist);if(ks!=="unused")btn.classList.add("key-"+ks);}
      btn.addEventListener("click",e=>{
        e.stopPropagation();setActive(player);
        const pos=player==="A"?cursorA:cursorB;
        const cur=player==="A"?inputA:inputB;
        if(k==="ENTER"){submitGuess(player);}
        else if(k==="⌫"){
          const arr=(cur+"     ").slice(0,5).split("");
          arr.splice(pos,1);arr.push(" ");
          const ns=arr.join("").replace(/ +$/,"");
          const np=Math.max(0,pos>0?pos-1:0);
          if(player==="A"){inputA=ns;cursorA=np;}else{inputB=ns;cursorB=np;}
          renderPlay();
        }else if(/^[A-ZÄÖÜ]$/.test(k)){
          const ns=insertAt(cur,pos,k);
          const np=Math.min(4,pos+1);
          if(player==="A"){inputA=ns;cursorA=np;}else{inputB=ns;cursorB=np;}
          renderPlay();
        }
      });
      rowEl.appendChild(btn);
    });
    el.appendChild(rowEl);
  });
}

function renderResult(){
  const s=state;
  const attA=s.histA&&s.histA.length||0,attB=s.histB&&s.histB.length||0;
  let winner="";
  if(s.forfeitBy)winner=s.forfeitBy==="A"?s.nameB:s.nameA;
  else if(s.wonA&&!s.wonB)winner=s.nameA;
  else if(s.wonB&&!s.wonA)winner=s.nameB;
  else if(s.wonA&&s.wonB)winner=attA<=attB?s.nameA:s.nameB;
  const wt=document.getElementById("winner-text");
  const isA=winner===s.nameA;
  wt.innerHTML=winner?"<span style='color:"+(isA?"#4a9eff":"#ff6b8a")+"'>"+winner.toUpperCase()+" GEWINNT!</span>":"<span style='color:#c89030'>UNENTSCHIEDEN</span>";
  if(s.forfeitBy)wt.innerHTML+="<div style='color:#555;font-size:11px;margin-top:8px'>durch Aufgabe</div>";
  const cards=document.getElementById("result-cards");cards.innerHTML="";
  [[s.nameA||"A","#4a9eff","#1a3a6a",s.wonA,attA,s.wordListB&&s.wordListB[s.wordIdxA]||"?????"],
   [s.nameB||"B","#ff6b8a","#6a1a2a",s.wonB,attB,s.wordListA&&s.wordListA[s.wordIdxB]||"?????"]].forEach(function(arr){
    const name=arr[0],col=arr[1],dim=arr[2],won=arr[3],att=arr[4],word=arr[5];
    const isW=winner===name;
    const d=document.createElement("div");
    d.style.cssText="background:#0a0a0a;border:1px solid "+(isW?col:dim)+";border-radius:8px;padding:22px 28px;text-align:center;min-width:165px;"+(isW?"box-shadow:0 0 26px "+col+"44":"");
    d.innerHTML=(isW?"<div style='font-size:22px;margin-bottom:6px'>&#127942;</div>":"")+"<div style='color:"+col+";font-size:11px;letter-spacing:4px;margin-bottom:10px'>"+name.toUpperCase()+"</div><div style='color:#fff;font-size:30px;font-weight:700;font-family:monospace'>"+att+"</div><div style='color:#555;font-size:10px;letter-spacing:2px;margin-bottom:8px'>VERSUCHE</div><div style='color:"+(won?"#4ab855":"#e05030")+";font-size:11px;letter-spacing:2px'>"+(won?"GELOEST":"NICHT GELOEST")+"</div><div style='color:#444;font-size:10px;margin-top:8px'>Wort: <span style='color:"+col+";font-family:monospace'>"+word+"</span></div>";
    cards.appendChild(d);
  });
}

window.showAdmin=function(){adminOpen=true;document.getElementById("admin-panel").style.display="flex";document.getElementById("admin-login").style.display="block";document.getElementById("admin-content").style.display="none";document.getElementById("admin-pw-msg").textContent="";document.getElementById("admin-pw-input").value="";};
window.closeAdmin=function(){adminOpen=false;document.getElementById("admin-panel").style.display="none";};
window.checkAdminPw=async function(){
  if(document.getElementById("admin-pw-input").value===ADMIN_PW){
    document.getElementById("admin-login").style.display="none";
    document.getElementById("admin-content").style.display="block";
    await loadStats();
  }else{document.getElementById("admin-pw-msg").textContent="Falsches Passwort";}
};
async function loadStats(){
  const data=await fsRead("duel/stats");const games=data&&data.games||[];
  const list=document.getElementById("stats-list");
  if(!games.length){list.innerHTML="<div style='color:#444;font-size:12px;text-align:center;padding:16px'>Noch keine Spiele</div>";return;}
  list.innerHTML="<div style='color:#555;font-size:10px;letter-spacing:2px;margin-bottom:10px'>"+games.length+" SPIELE</div>"+[...games].reverse().map(g=>"<div class='stat-row'><div><div style='color:#ccc;font-size:12px'>"+g.date+" "+g.time+"</div><div style='color:#555;font-size:10px;margin-top:2px'>"+g.playerA+" vs "+g.playerB+"</div></div><div style='text-align:right'><div style='color:"+(g.winner===g.playerA?"#4a9eff":"#ff6b8a")+";font-size:12px;font-weight:700'>"+(g.winner||"?")+"</div><div style='color:#444;font-size:10px'>"+g.attemptsA+" : "+g.attemptsB+"</div>"+(g.forfeit?"<div style='color:#e05030;font-size:9px'>Aufgabe</div>":"")+"</div></div>").join("");
}
window.clearStats=async function(){if(!confirm("Wirklich loeschen?"))return;await fsWrite("duel/stats",{games:[]});await loadStats();};

// Boot
subscribe();

// QR Code with fixed URL
setTimeout(()=>{
  try{
    new QRCode(document.getElementById("qrcode"),{
      text:"https://disswurdjetztaberauchzeit.github.io/wordle-duell/",
      width:130,height:130,
      colorDark:"#111111",colorLight:"#ffffff",
      correctLevel:QRCode.CorrectLevel.M
    });
  }catch(e){console.warn("QR error:",e);}
},200);
</script>
</body>
</html>
