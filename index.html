<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Wordle Duell</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:#080808;color:#ccc;font-family:'Courier New',monospace;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px 10px 40px}
.vs-title{font-size:26px;letter-spacing:10px;font-weight:700;background:linear-gradient(90deg,#4a9eff,#ff6b8a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.subtitle{color:#555;font-size:11px;letter-spacing:4px;margin-top:4px;text-align:center}
.panel{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:8px;padding:24px}
button{font-family:'Courier New',monospace;cursor:pointer;letter-spacing:2px;transition:all 0.2s;border-radius:4px;border:none}
.btn{background:transparent;border:1px solid #333;color:#888;font-size:11px;padding:9px 20px}
.btn:hover{border-color:#555;color:#ccc}
.btn-go{background:linear-gradient(90deg,#1a3a6a,#6a1a2a);border:1px solid #555;color:#fff;padding:11px 36px;font-size:12px}
.btn-go:disabled{opacity:0.3;cursor:not-allowed}
.btn-danger{border:1px solid #6a1a1a;color:#ff4444;background:#1a0808;font-size:10px;padding:7px 16px;letter-spacing:1px}
label{color:#555;font-size:10px;letter-spacing:2px;display:block;margin-bottom:5px;margin-top:12px}
input[type=text],input[type=password],input[type=number]{background:#0a0a0a;border:1px solid #333;color:#fff;border-radius:4px;padding:10px 12px;font-family:'Courier New',monospace;font-size:15px;width:100%;outline:none;transition:border-color 0.2s}
input:focus{border-color:#555}
input[type=number]{-moz-appearance:textfield}
input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
.tile{width:52px;height:52px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;border-radius:4px;border:2px solid #1a1a1a;background:#0d0d0d;color:transparent;transition:background 0.3s,border-color 0.3s,color 0.15s;flex-shrink:0;position:relative}
.tile.filled-a{border-color:#4a9eff;background:#0d1f3a;color:#4a9eff}
.tile.filled-b{border-color:#ff6b8a;background:#3a0d1a;color:#ff6b8a}
.tile.correct{background:#2d7a3a;border-color:#4ab855;color:#fff}
.tile.present{background:#8a6010;border-color:#c89030;color:#fff}
.tile.absent{background:#1a1a1a;border-color:#1a1a1a;color:#444}
.grid{display:flex;flex-direction:column;gap:5px}
.grid-row{display:flex;gap:5px;position:relative}
.keyboard{display:flex;flex-direction:column;gap:4px;margin-top:14px}
.kb-row{display:flex;gap:3px;justify-content:center}
.key{background:#1e1e2e;color:#888;border:1px solid #333;border-radius:4px;font-weight:700;width:30px;height:38px;font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-family:'Courier New',monospace;transition:background 0.15s,color 0.15s}
.key:active{transform:scale(0.93)}
.key.wide-enter{width:54px;font-size:8px;letter-spacing:0.5px}
.key.wide-del{width:40px}
.key.key-correct{background:#2d7a3a;color:#fff;border-color:#4ab855}
.key.key-present{background:#8a6010;color:#fff;border-color:#c89030}
.key.key-absent{background:#111;color:#333;border-color:#111}
#play-screen{display:flex;width:100%;max-width:960px;gap:0}
.side{flex:1;display:flex;flex-direction:column;align-items:center;padding:16px 10px;border-top:3px solid}
.side-a{background:#060d1a;border-color:#4a9eff}
.side-b{background:#1a060d;border-color:#ff6b8a;border-left:1px solid #111}
.toast{background:#111;border:1px solid #333;border-radius:4px;padding:8px 20px;font-size:12px;letter-spacing:1px;color:#ccc;margin-bottom:10px;text-align:center;animation:fadeDown 0.2s;max-width:500px;width:100%}
@keyframes fadeDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-7px)}40%{transform:translateX(7px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:0.4}}
.invalid-shake{animation:shake 0.4s}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #151515;font-size:12px}
#admin-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;align-items:center;justify-content:center}
.timer-bar{height:3px;background:#333;border-radius:2px;width:100%;margin-bottom:8px;overflow:hidden}
.timer-fill{height:100%;border-radius:2px;transition:width 1s linear,background 1s linear}
.row-timer{position:absolute;right:-36px;top:50%;transform:translateY(-50%);font-size:10px;letter-spacing:0;color:#555;width:30px;text-align:center}
.waiting-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin:0 2px;animation:timerPulse 1.2s infinite}
</style>
</head>
<body>

<div style="text-align:center;margin-bottom:18px;width:100%">
  <div class="vs-title">WORDLE DUELL</div>
  <div id="phase-label" class="subtitle"></div>
</div>
<div id="toast" class="toast" style="display:none"></div>

<!-- â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen" style="display:none;width:100%;max-width:460px">
  <div class="panel" style="border-color:#222">
    <div style="color:#666;font-size:10px;letter-spacing:3px;margin-bottom:22px;text-align:center">ANMELDEN</div>

    <label>DEIN NAME</label>
    <input type="text" id="login-name" placeholder="Name eingebenâ€¦" maxlength="20"
      onkeydown="if(event.key==='Enter')doLogin()"/>

    <label>MAX. FEHLVERSUCHE <span style="color:#333">(es gilt die niedrigere Zahl beider Spieler)</span></label>
    <input type="number" id="login-maxfail" value="6" min="1" max="20" style="margin-bottom:4px"/>

    <label>TIMER PRO ZEILE <span style="color:#333">(Minuten, 0 = kein Timer)</span></label>
    <input type="number" id="login-timer" value="0" min="0" max="30" style="margin-bottom:18px"/>

    <button class="btn-go" style="width:100%" onclick="doLogin()">SPIELEN â†’</button>

    <div id="login-waiting" style="display:none;color:#555;font-size:11px;letter-spacing:2px;text-align:center;margin-top:16px;padding:10px">
      <span class="waiting-dot" style="background:#4a9eff"></span>
      <span class="waiting-dot" style="background:#ff6b8a;animation-delay:0.4s"></span>
      <span class="waiting-dot" style="background:#4a9eff;animation-delay:0.8s"></span>
      <div style="margin-top:8px" id="login-wait-msg"></div>
    </div>
  </div>
  <div style="text-align:center;margin-top:14px">
    <button class="btn" onclick="showAdmin()">ğŸ“Š STATISTIK (ADMIN)</button>
  </div>
</div>

<!-- â•â• PICK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="pick-screen" style="display:none;width:100%;max-width:720px">
  <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center">

    <div class="panel" id="pick-panel-a" style="border-color:#1a3a6a;min-width:280px;flex:1">
      <div id="pick-title-a" style="color:#4a9eff;font-size:11px;letter-spacing:3px;margin-bottom:14px;font-weight:700"></div>
      <div style="color:#444;font-size:10px;letter-spacing:1px;margin-bottom:6px">WÃ¶rter komma-getrennt (5 Buchstaben):</div>
      <input type="text" id="pick-input-a" placeholder="HUNDE, KATZE, VOGELâ€¦"
        oninput="this.value=this.value.toUpperCase()"
        onkeydown="if(event.key==='Enter')submitPick('A')"/>
      <div id="pick-msg-a" style="color:#e05030;font-size:10px;min-height:14px;letter-spacing:1px;margin-bottom:8px"></div>
      <div id="pick-done-a" style="display:none;color:#4ab855;font-size:11px;letter-spacing:2px;text-align:center;padding:10px">âœ… WÃ–RTER GESETZT</div>
      <button class="btn" id="pick-btn-a" style="border-color:#1a3a6a;color:#4a9eff;background:#060d1a;width:100%" onclick="submitPick('A')">FESTLEGEN â†’</button>
    </div>

    <div class="panel" id="pick-panel-b" style="border-color:#6a1a2a;min-width:280px;flex:1">
      <div id="pick-title-b" style="color:#ff6b8a;font-size:11px;letter-spacing:3px;margin-bottom:14px;font-weight:700"></div>
      <div style="color:#444;font-size:10px;letter-spacing:1px;margin-bottom:6px">WÃ¶rter komma-getrennt (5 Buchstaben):</div>
      <input type="text" id="pick-input-b" placeholder="HUNDE, KATZE, VOGELâ€¦"
        oninput="this.value=this.value.toUpperCase()"
        onkeydown="if(event.key==='Enter')submitPick('B')"/>
      <div id="pick-msg-b" style="color:#e05030;font-size:10px;min-height:14px;letter-spacing:1px;margin-bottom:8px"></div>
      <div id="pick-done-b" style="display:none;color:#ff6b8a;font-size:11px;letter-spacing:2px;text-align:center;padding:10px">âœ… WÃ–RTER GESETZT</div>
      <button class="btn" id="pick-btn-b" style="border-color:#6a1a2a;color:#ff6b8a;background:#1a060d;width:100%" onclick="submitPick('B')">FESTLEGEN â†’</button>
    </div>

  </div>
  <div style="text-align:center;margin-top:18px">
    <button class="btn btn-danger" onclick="forfeit()">âœ— ABBRECHEN / AUFGEBEN</button>
  </div>
</div>

<!-- â•â• PLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="play-screen" style="display:none">

  <div class="side side-a" id="side-a" onclick="setActive('A')">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span id="name-display-a" style="color:#4a9eff;font-size:13px;font-weight:700;letter-spacing:3px"></span>
      <span id="attempts-a" style="color:#333;font-size:11px"></span>
    </div>
    <div class="timer-bar" id="tbar-a" style="display:none"><div class="timer-fill" id="tfill-a" style="width:100%;background:#4a9eff"></div></div>
    <div id="done-banner-a" style="display:none;border-radius:6px;padding:9px 14px;margin-bottom:10px;text-align:center;font-size:11px;letter-spacing:2px"></div>
    <div id="main-grid-a" class="grid" style="position:relative"></div>
    <div id="keyboard-a" class="keyboard"></div>
    <div style="margin-top:14px"><button class="btn btn-danger" onclick="forfeit()">âœ— AUFGEBEN</button></div>
  </div>

  <div class="side side-b" id="side-b" onclick="setActive('B')">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span id="name-display-b" style="color:#ff6b8a;font-size:13px;font-weight:700;letter-spacing:3px"></span>
      <span id="attempts-b" style="color:#333;font-size:11px"></span>
    </div>
    <div class="timer-bar" id="tbar-b" style="display:none"><div class="timer-fill" id="tfill-b" style="width:100%;background:#ff6b8a"></div></div>
    <div id="done-banner-b" style="display:none;border-radius:6px;padding:9px 14px;margin-bottom:10px;text-align:center;font-size:11px;letter-spacing:2px"></div>
    <div id="main-grid-b" class="grid" style="position:relative"></div>
    <div id="keyboard-b" class="keyboard"></div>
    <div style="margin-top:14px"><button class="btn btn-danger" onclick="forfeit()">âœ— AUFGEBEN</button></div>
  </div>

</div>

<!-- â•â• RESULT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="result-screen" style="display:none;flex-direction:column;align-items:center">
  <div id="winner-text" style="font-size:18px;letter-spacing:6px;font-weight:700;margin-bottom:20px;text-align:center"></div>
  <div id="result-cards" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-bottom:24px"></div>
  <button class="btn-go" onclick="newGame()">NEUE RUNDE â†’</button>
</div>

<!-- â•â• ADMIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="admin-panel">
  <div class="panel" style="border-color:#333;min-width:320px;max-width:540px;width:92%;max-height:88vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="color:#888;font-size:12px;letter-spacing:4px">STATISTIK</div>
      <button class="btn" onclick="closeAdmin()">âœ•</button>
    </div>
    <div id="admin-login">
      <div style="color:#444;font-size:10px;letter-spacing:1px;margin-bottom:10px;line-height:1.7">
        Merksatz: â€Ich mag Worte, die man nicht aussprechen kann." â€“ Karl Valentin
      </div>
      <input type="password" id="admin-pw-input" placeholder="Passwortâ€¦"
        onkeydown="if(event.key==='Enter')checkAdminPw()"/>
      <button class="btn" style="width:100%;margin-top:4px" onclick="checkAdminPw()">ENTSPERREN</button>
      <div id="admin-pw-msg" style="color:#e05030;font-size:10px;margin-top:8px;min-height:14px"></div>
    </div>
    <div id="admin-content" style="display:none">
      <div id="stats-list"></div>
      <div style="margin-top:18px;padding-top:14px;border-top:1px solid #1a1a1a;display:flex;gap:10px">
        <button class="btn btn-danger" style="flex:1" onclick="clearStats()">LÃ–SCHEN</button>
        <button class="btn" style="flex:1" onclick="closeAdmin()">SCHLIESSEN</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â• QR CODE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="margin-top:48px;text-align:center;opacity:0.5">
  <div style="font-size:9px;letter-spacing:3px;color:#444;margin-bottom:12px">MITSPIELEN</div>
  <div id="qrcode" style="display:inline-block;background:#fff;padding:10px;border-radius:6px"></div>
  <div style="font-size:9px;letter-spacing:1px;color:#333;margin-top:8px" id="qr-url"></div>
</div>

<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc }
                           from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = initializeApp({
  apiKey:            "AIzaSyCCMItvN8RNbnWi_V6KdBmhYwFxl53R9R0",
  authDomain:        "wordle-duell.firebaseapp.com",
  projectId:         "wordle-duell",
  storageBucket:     "wordle-duell.firebasestorage.app",
  messagingSenderId: "10346209099",
  appId:             "1:10346209099:web:409827941bd01a5b6c12ce",
});
const db = getFirestore(app);

// â”€â”€ Admin password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â€Ich mag Worte, die man nicht aussprechen kann." â€“ Karl Valentin
const ADMIN_PW = "Wrglpfrmpft";

const KB_ROWS = [
  ["Q","W","E","R","T","Z","U","I","O","P","Ãœ"],
  ["A","S","D","F","G","H","J","K","L","Ã–","Ã„"],
  ["ENTER","Y","X","C","V","B","N","M","âŒ«"],
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state    = null;
let myRole   = null;   // "A" | "B" â€” assigned at login
let inputA   = "";
let inputB   = "";
let activeKB = "A";
let adminOpen = false;
let unsub    = null;
// Timer
let timerInterval = null;
let rowStartTime  = null;

function fresh() {
  return {
    phase:    "login",           // login | pick | play | result
    nameA:"", nameB:"",
    maxFailA: 6, maxFailB: 6,
    timerMin: 0,                 // minutes per row (0 = off)
    wordListA:[], wordListB:[],  // A's list goes to B, B's list goes to A
    wordIdxA:0,  wordIdxB:0,
    pickedA:false, pickedB:false,
    histA:[], histB:[],
    doneA:false, wonA:false,
    doneB:false, wonB:false,
    forfeitBy:"",
    rowStartA: null, rowStartB: null,
  };
}

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fsRead(path)     { const [c,i]=path.split("/"); const s=await getDoc(doc(db,c,i)); return s.exists()?s.data():null; }
async function fsWrite(path, d) { const [c,i]=path.split("/"); await setDoc(doc(db,c,i),d); }

function subscribe() {
  if (unsub) unsub();
  unsub = onSnapshot(doc(db,"duel","state"), snap => {
    const prev = state;
    state = snap.exists() ? snap.data() : fresh();
    if (!snap.exists()) fsWrite("duel/state", state);
    // Detect row change for timer reset
    if (myRole && prev && state.phase==="play") {
      const prevLen = myRole==="A" ? prev.histA?.length : prev.histB?.length;
      const curLen  = myRole==="A" ? state.histA?.length : state.histB?.length;
      if (curLen !== prevLen) rowStartTime = Date.now();
    }
    renderAll();
  });
}

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doLogin = async function() {
  const name = document.getElementById("login-name").value.trim();
  const mf   = parseInt(document.getElementById("login-maxfail").value)||6;
  const tm   = parseFloat(document.getElementById("login-timer").value)||0;
  if (!name) { showToast("Bitte Namen eingeben"); return; }

  const cur = state || fresh();

  // Determine role: first in gets A, second gets B
  if (!cur.nameA) {
    myRole = "A";
    const upd = { ...cur, nameA:name, maxFailA:mf, timerMin:tm };
    await fsWrite("duel/state", upd);
    document.getElementById("login-waiting").style.display = "block";
    document.getElementById("login-wait-msg").textContent  = `Warte auf Mitspielerâ€¦`;
  } else if (!cur.nameB) {
    myRole = "B";
    const timerMin = Math.min(cur.timerMin||0, tm) || Math.max(cur.timerMin||0, tm); // use whichever non-zero, or average
    const maxFail  = Math.min(cur.maxFailA, mf);
    const upd = {
      ...cur, nameB:name, maxFailA:maxFail, maxFailB:maxFail,
      timerMin: (cur.timerMin>0||tm>0) ? Math.min(cur.timerMin||999, tm||999) : 0,
      phase:"pick"
    };
    await fsWrite("duel/state", upd);
  } else {
    // Reconnect: figure out who we are by name
    if (cur.nameA === name) myRole = "A";
    else if (cur.nameB === name) myRole = "B";
    else { showToast("Spiel lÃ¤uft bereits mit anderen Spielern"); return; }
  }
};

// â”€â”€ Pick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.submitPick = async function(player) {
  const raw   = document.getElementById(`pick-input-${player.toLowerCase()}`).value;
  const words = raw.split(",").map(w=>w.trim().toUpperCase().replace(/[^A-ZÃ„Ã–Ãœ]/g,"")).filter(w=>w.length===5);
  const msg   = document.getElementById(`pick-msg-${player.toLowerCase()}`);
  const all   = raw.split(",").map(w=>w.trim().toUpperCase().replace(/[^A-ZÃ„Ã–Ãœ]/g,"")).filter(w=>w);
  const wrong = all.filter(w=>w.length!==5);
  if (!words.length) { msg.textContent="Mindestens ein 5-Buchstaben-Wort eingeben"; return; }
  if (wrong.length)  { msg.textContent=`Nicht 5 Buchstaben: ${wrong.join(", ")}`; return; }
  msg.textContent="";
  const upd = { ...state };
  if (player==="A") { upd.wordListA=words; upd.pickedA=true; }
  else              { upd.wordListB=words; upd.pickedB=true; }
  if (upd.pickedA && upd.pickedB) {
    Object.assign(upd, {
      phase:"play", histA:[], histB:[],
      doneA:false, wonA:false, doneB:false, wonB:false,
      wordIdxA:0, wordIdxB:0, forfeitBy:"",
      rowStartA: Date.now(), rowStartB: Date.now(),
    });
  }
  await fsWrite("duel/state", upd);
};

// â”€â”€ Forfeit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.forfeit = async function() {
  if (!confirm(`Wirklich aufgeben?`)) return;
  const upd = { ...state, forfeitBy:myRole||"?", phase:"result", doneA:true, doneB:true };
  if (myRole==="A") { upd.wonA=false; upd.wonB=true; }
  else              { upd.wonB=false; upd.wonA=true; }
  await fsWrite("duel/state", upd);
  await saveResult(upd);
};

// â”€â”€ Wordle logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function evaluate(guess, target) {
  const res=Array(5).fill("absent"), t=[...target], g=[...guess];
  g.forEach((c,i)=>{ if(c===t[i]){res[i]="correct";t[i]=null;g[i]=null;} });
  g.forEach((c,i)=>{ if(!c)return; const ti=t.indexOf(c); if(ti!==-1){res[i]="present";t[ti]=null;} });
  return res;
}
function keyState(letter, hist) {
  let best="unused";
  for(const row of hist){ row.word.split("").forEach((c,i)=>{ if(c!==letter)return; const s=row.states[i]; if(s==="correct")best="correct"; else if(s==="present"&&best!=="correct")best="present"; else if(s==="absent"&&best==="unused")best="absent"; }); }
  return best;
}

// â”€â”€ Submit guess â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitGuess(player) {
  if (!state||state.phase!=="play") return;
  const done = player==="A" ? state.doneA : state.doneB;
  if (done) return;
  const inp    = player==="A" ? inputA : inputB;
  const wlist  = player==="A" ? state.wordListB : state.wordListA;
  const widx   = player==="A" ? state.wordIdxA  : state.wordIdxB;
  const target = wlist[widx % wlist.length];
  const maxF   = state.maxFailA || 6;  // same for both

  if (inp.length!==5) { shakeCurrent(player); showToast("5 Buchstaben nÃ¶tig"); return; }

  const states = evaluate(inp, target);
  const won    = inp === target;
  const upd    = { ...state, histA:[...state.histA], histB:[...state.histB] };
  const now    = Date.now();

  if (player==="A") {
    upd.histA.push({word:inp, states});
    upd.rowStartA = now;
    if (won && upd.wordIdxA+1 < wlist.length) { upd.wordIdxA++; upd.histA=[]; }
    else if (won || upd.histA.length >= maxF)  { upd.doneA=true; upd.wonA=won; }
    inputA="";
  } else {
    upd.histB.push({word:inp, states});
    upd.rowStartB = now;
    if (won && upd.wordIdxB+1 < wlist.length) { upd.wordIdxB++; upd.histB=[]; }
    else if (won || upd.histB.length >= maxF)  { upd.doneB=true; upd.wonB=won; }
    inputB="";
  }

  if (upd.doneA && upd.doneB) { upd.phase="result"; await fsWrite("duel/state", upd); await saveResult(upd); }
  else await fsWrite("duel/state", upd);
}

function shakeCurrent(player) {
  const el  = document.getElementById(`main-grid-${player.toLowerCase()}`);
  const len = player==="A" ? state.histA.length : state.histB.length;
  const row = el?.querySelectorAll(".grid-row")[len];
  if (row) { row.classList.add("invalid-shake"); setTimeout(()=>row.classList.remove("invalid-shake"),400); }
}

// â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimerLoop() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!state||state.phase!=="play"||!state.timerMin) return;
    const totalMs = state.timerMin * 60000;
    ["A","B"].forEach(p => {
      const done = p==="A" ? state.doneA : state.doneB;
      if (done) return;
      const startTs = p==="A" ? state.rowStartA : state.rowStartB;
      if (!startTs) return;
      const elapsed = Date.now() - startTs;
      const pct = Math.max(0, 100 - (elapsed/totalMs*100));
      const fill = document.getElementById(`tfill-${p.toLowerCase()}`);
      const bar  = document.getElementById(`tbar-${p.toLowerCase()}`);
      if (fill) { fill.style.width=pct+"%"; fill.style.background=pct>50?"#4ab855":pct>20?"#c89030":"#e05030"; }
      if (bar)  bar.style.display = state.timerMin>0 ? "block":"none";
      // Time's up â†’ auto-submit empty (forfeit row)
      if (elapsed >= totalMs && myRole===p) {
        // Force move: submit current input even if incomplete (treated as forfeit of row)
        const inp = p==="A" ? inputA : inputB;
        if (inp.length===5) submitGuess(p);
        else {
          // fill with X and force
          if (p==="A") inputA = (inp+"XXXXX").slice(0,5);
          else         inputB = (inp+"XXXXX").slice(0,5);
          submitGuess(p);
        }
      }
    });
  }, 500);
}

// â”€â”€ Save stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveResult(s) {
  const attA=s.histA?.length||0, attB=s.histB?.length||0;
  let winner="";
  if(s.forfeitBy) winner=s.forfeitBy==="A"?(s.nameB||"B"):(s.nameA||"A");
  else if(s.wonA&&!s.wonB) winner=s.nameA;
  else if(s.wonB&&!s.wonA) winner=s.nameB;
  else if(s.wonA&&s.wonB)  winner=attA<=attB?s.nameA:s.nameB;
  const entry={
    date:new Date().toLocaleDateString("de-DE"),
    time:new Date().toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),
    playerA:s.nameA||"A", playerB:s.nameB||"B",
    attemptsA:attA, attemptsB:attB,
    wonA:!!s.wonA, wonB:!!s.wonB,
    forfeit:s.forfeitBy||"", winner,
  };
  const cur = await fsRead("duel/stats") || {games:[]};
  cur.games = [...(cur.games||[]), entry];
  await fsWrite("duel/stats", cur);
}

// â”€â”€ New game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.newGame = async function() {
  inputA=""; inputB="";
  const s = fresh();
  // Keep names so players don't need to re-login, but go back to pick
  s.nameA=state.nameA||""; s.nameB=state.nameB||"";
  s.maxFailA=state.maxFailA||6; s.maxFailB=state.maxFailB||6;
  s.timerMin=state.timerMin||0;
  s.phase = (s.nameA&&s.nameB) ? "pick" : "login";
  await fsWrite("duel/state", s);
};

// â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("keydown", e => {
  if (adminOpen||!state||state.phase!=="play") return;
  const p = activeKB;
  if ((p==="A"?state.doneA:state.doneB)) return;
  if (e.key==="Enter")     { submitGuess(p); return; }
  if (e.key==="Backspace") {
    if(p==="A") inputA=inputA.slice(0,-1); else inputB=inputB.slice(0,-1);
    renderPlay(); return;
  }
  const k=e.key.toUpperCase();
  if (/^[A-ZÃ„Ã–Ãœ]$/.test(k)) {
    const cur=p==="A"?inputA:inputB;
    if(cur.length<5){ if(p==="A")inputA+=k; else inputB+=k; renderPlay(); }
  }
});
window.setActive = function(p) { activeKB=p; highlightActive(); };
function highlightActive() {
  document.getElementById("side-a").style.outline=activeKB==="A"?"2px solid #4a9eff33":"none";
  document.getElementById("side-b").style.outline=activeKB==="B"?"2px solid #ff6b8a33":"none";
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  if (!state) return;
  const labels={login:"ANMELDEN",pick:"WÃ–RTER WÃ„HLEN",play:"DUELL",result:"ERGEBNIS"};
  document.getElementById("phase-label").textContent=labels[state.phase]||"";
  S("login-screen",  state.phase==="login"  ?"block":"none");
  S("pick-screen",   state.phase==="pick"   ?"block":"none");
  S("play-screen",   state.phase==="play"   ?"flex" :"none");
  S("result-screen", state.phase==="result" ?"flex" :"none");
  if(state.phase==="login")  renderLogin();
  if(state.phase==="pick")   renderPick();
  if(state.phase==="play")  { renderPlay(); startTimerLoop(); }
  if(state.phase==="result") renderResult();
}

function renderLogin() {
  const waiting=document.getElementById("login-waiting");
  if (state.nameA && !state.nameB) {
    waiting.style.display="block";
    document.getElementById("login-wait-msg").textContent=`${state.nameA} wartet auf Mitspielerâ€¦`;
  }
}

function renderPick() {
  const nA=state.nameA||"Spieler A", nB=state.nameB||"Spieler B";
  document.getElementById("pick-title-a").textContent=`${nA.toUpperCase()} WÃ„HLT FÃœR ${nB.toUpperCase()}`;
  document.getElementById("pick-title-b").textContent=`${nB.toUpperCase()} WÃ„HLT FÃœR ${nA.toUpperCase()}`;
  if(state.pickedA){S("pick-done-a","block");S("pick-btn-a","none");}
  if(state.pickedB){S("pick-done-b","block");S("pick-btn-b","none");}
}

function renderPlay() {
  if(!state||state.phase!=="play") return;
  const nA=state.nameA||"A", nB=state.nameB||"B";
  document.getElementById("name-display-a").textContent=nA.toUpperCase();
  document.getElementById("name-display-b").textContent=nB.toUpperCase();
  const maxF=state.maxFailA||6;
  const wlA=state.wordListB||[], wlB=state.wordListA||[];
  const tA=wlA[(state.wordIdxA||0)%wlA.length]||"?????";
  const tB=wlB[(state.wordIdxB||0)%wlB.length]||"?????";
  let attTxtA=`${state.histA.length}/${maxF}`;
  let attTxtB=`${state.histB.length}/${maxF}`;
  if(wlA.length>1) attTxtA+=` Â· Wort ${(state.wordIdxA||0)+1}/${wlA.length}`;
  if(wlB.length>1) attTxtB+=` Â· Wort ${(state.wordIdxB||0)+1}/${wlB.length}`;
  document.getElementById("attempts-a").textContent=attTxtA;
  document.getElementById("attempts-b").textContent=attTxtB;
  renderMainGrid("main-grid-a",state.histA,inputA,tA,"A",maxF);
  renderMainGrid("main-grid-b",state.histB,inputB,tB,"B",maxF);
  renderDoneBanner("done-banner-a",state.doneA,state.wonA,tA,"A");
  renderDoneBanner("done-banner-b",state.doneB,state.wonB,tB,"B");
  renderKeyboard("keyboard-a",state.histA,"A");
  renderKeyboard("keyboard-b",state.histB,"B");
  document.getElementById("tbar-a").style.display=state.timerMin>0?"block":"none";
  document.getElementById("tbar-b").style.display=state.timerMin>0?"block":"none";
  highlightActive();
}

function renderMainGrid(id,hist,inp,target,player,maxF) {
  const el=document.getElementById(id); el.innerHTML="";
  const done=player==="A"?state.doneA:state.doneB;
  const rows=Math.max(maxF,hist.length+(done?0:1));
  for(let r=0;r<rows;r++){
    const row=document.createElement("div"); row.className="grid-row";
    const committed=r<hist.length, current=r===hist.length&&!done;
    const word=committed?hist[r].word:current?inp:"";
    const states=committed?hist[r].states:null;
    for(let c=0;c<5;c++){
      const t=document.createElement("div"); t.className="tile";
      const l=word[c]||""; t.textContent=l;
      if(committed) t.classList.add(states[c]);
      else if(l)    t.classList.add(`filled-${player.toLowerCase()}`);
      row.appendChild(t);
    }
    el.appendChild(row);
  }
}

function renderDoneBanner(id,done,won,word,player) {
  const el=document.getElementById(id);
  if(!done){el.style.display="none";return;}
  el.style.display="block";
  el.style.background=won?"#0d2a10":"#2a0d0a";
  el.style.border=won?"1px solid #4ab855":"1px solid #e05030";
  el.style.color=won?"#4ab855":"#e05030";
  el.innerHTML=won?"âœ“ GELÃ–ST!":`âœ— NICHT GELÃ–ST<br><span style="color:#555;font-size:10px">Wort: <span style="color:${player==="A"?"#4a9eff":"#ff6b8a"};font-family:monospace">${word}</span></span>`;
}

function renderKeyboard(id,hist,player) {
  const el=document.getElementById(id); el.innerHTML="";
  if(player==="A"?state.doneA:state.doneB) return;
  KB_ROWS.forEach(row=>{
    const rowEl=document.createElement("div"); rowEl.className="kb-row";
    row.forEach(k=>{
      const btn=document.createElement("button"); btn.className="key";
      if(k==="ENTER")btn.classList.add("wide-enter");
      else if(k==="âŒ«")btn.classList.add("wide-del");
      btn.textContent=k;
      if(!["ENTER","âŒ«"].includes(k)){const ks=keyState(k,hist);if(ks!=="unused")btn.classList.add(`key-${ks}`);}
      btn.addEventListener("click",e=>{
        e.stopPropagation(); activeKB=player;
        const cur=player==="A"?inputA:inputB;
        if(k==="ENTER") submitGuess(player);
        else if(k==="âŒ«"){if(player==="A")inputA=inputA.slice(0,-1);else inputB=inputB.slice(0,-1);renderPlay();}
        else if(cur.length<5&&/^[A-ZÃ„Ã–Ãœ]$/.test(k)){if(player==="A")inputA+=k;else inputB+=k;renderPlay();}
      });
      rowEl.appendChild(btn);
    });
    el.appendChild(rowEl);
  });
}

function renderResult() {
  const s=state;
  const attA=s.histA?.length||0, attB=s.histB?.length||0;
  let winner="";
  if(s.forfeitBy) winner=s.forfeitBy==="A"?s.nameB:s.nameA;
  else if(s.wonA&&!s.wonB) winner=s.nameA;
  else if(s.wonB&&!s.wonA) winner=s.nameB;
  else if(s.wonA&&s.wonB)  winner=attA<=attB?s.nameA:s.nameB;
  const wt=document.getElementById("winner-text");
  const isA=winner===s.nameA;
  wt.innerHTML=winner
    ?`<span style="color:${isA?"#4a9eff":"#ff6b8a"}">${winner.toUpperCase()} GEWINNT! ğŸ†</span>`
    :`<span style="color:#c89030">UNENTSCHIEDEN</span>`;
  if(s.forfeitBy) wt.innerHTML+=`<div style="color:#555;font-size:11px;letter-spacing:2px;margin-top:8px">durch Aufgabe</div>`;

  const cards=document.getElementById("result-cards"); cards.innerHTML="";
  [[s.nameA||"A","#4a9eff","#1a3a6a",s.wonA,attA,s.wordListB?.[s.wordIdxA]||"?????"],
   [s.nameB||"B","#ff6b8a","#6a1a2a",s.wonB,attB,s.wordListA?.[s.wordIdxB]||"?????"]].forEach(([name,col,dim,won,att,word])=>{
    const isW=winner===name;
    const d=document.createElement("div");
    d.style.cssText=`background:#0a0a0a;border:1px solid ${isW?col:dim};border-radius:8px;padding:22px 28px;text-align:center;min-width:165px;${isW?`box-shadow:0 0 26px ${col}44`:""}`;
    d.innerHTML=`${isW?'<div style="font-size:22px;margin-bottom:6px">ğŸ†</div>':""}
      <div style="color:${col};font-size:11px;letter-spacing:4px;margin-bottom:10px">${name.toUpperCase()}</div>
      <div style="color:#fff;font-size:30px;font-weight:700;font-family:monospace">${att}</div>
      <div style="color:#555;font-size:10px;letter-spacing:2px;margin-bottom:8px">VERSUCHE</div>
      <div style="color:${won?"#4ab855":"#e05030"};font-size:11px;letter-spacing:2px">${won?"âœ“ GELÃ–ST":"âœ— NICHT GELÃ–ST"}</div>
      <div style="color:#444;font-size:10px;margin-top:8px">Wort: <span style="color:${col};font-family:monospace">${word}</span></div>`;
    cards.appendChild(d);
  });
}

// â”€â”€ Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showAdmin  = function(){adminOpen=true;document.getElementById("admin-panel").style.display="flex";document.getElementById("admin-login").style.display="block";document.getElementById("admin-content").style.display="none";document.getElementById("admin-pw-msg").textContent="";document.getElementById("admin-pw-input").value="";};
window.closeAdmin = function(){adminOpen=false;document.getElementById("admin-panel").style.display="none";};
window.checkAdminPw = async function(){
  if(document.getElementById("admin-pw-input").value===ADMIN_PW){
    document.getElementById("admin-login").style.display="none";
    document.getElementById("admin-content").style.display="block";
    await loadStats();
  } else { document.getElementById("admin-pw-msg").textContent="Falsches Passwort"; }
};
async function loadStats(){
  const data=await fsRead("duel/stats"); const games=data?.games||[];
  const list=document.getElementById("stats-list");
  if(!games.length){list.innerHTML='<div style="color:#444;font-size:12px;text-align:center;padding:16px">Noch keine Spiele</div>';return;}
  list.innerHTML=`<div style="color:#555;font-size:10px;letter-spacing:2px;margin-bottom:10px">${games.length} SPIELE</div>`
    +[...games].reverse().map(g=>`<div class="stat-row">
      <div><div style="color:#ccc;font-size:12px">${g.date} ${g.time}</div>
      <div style="color:#555;font-size:10px;margin-top:2px">${g.playerA} vs ${g.playerB}</div></div>
      <div style="text-align:right">
        <div style="color:${g.winner===g.playerA?"#4a9eff":"#ff6b8a"};font-size:12px;font-weight:700">${g.winner||"â€”"}</div>
        <div style="color:#444;font-size:10px">${g.attemptsA} : ${g.attemptsB} Versuche</div>
        ${g.forfeit?'<div style="color:#e05030;font-size:9px;margin-top:2px">Aufgabe</div>':""}
      </div></div>`).join("");
}
window.clearStats = async function(){if(!confirm("Wirklich lÃ¶schen?"))return;await fsWrite("duel/stats",{games:[]});await loadStats();};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function S(id,v){const el=document.getElementById(id);if(el)el.style.display=v;}
function showToast(m,d=2500){const el=document.getElementById("toast");el.textContent=m;el.style.display="block";clearTimeout(el._t);el._t=setTimeout(()=>el.style.display="none",d);}

// â”€â”€ QR Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildQR(){
  const url=window.location.href.split("?")[0].split("#")[0];
  document.getElementById("qr-url").textContent=url;
  try{new QRCode(document.getElementById("qrcode"),{text:url,width:120,height:120,colorDark:"#111",colorLight:"#fff"});}catch(e){}
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subscribe();
buildQR();
</script>
</body>
</html>
